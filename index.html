<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Super Tres-en-raya</title>
<style>
  body { font-family: sans-serif; background: #f0f4f8; color: #111; text-align: center; }
  #game { display: grid; grid-template-columns: repeat(3, 200px); gap: 10px; justify-content:center; margin-top:20px; }
  .board { background:#dbeafe; display:grid; grid-template-columns:repeat(3,1fr); aspect-ratio:1; position:relative; }
  .cell { border:1px solid #2563eb; display:flex; justify-content:center; align-items:center; font-size:2em; cursor:pointer; background:#93c5fd; }
  .cell.disabled { pointer-events:none; opacity:0.6; }
  .cell.allowed { outline:3px solid #fbbf24; }
  .x-mark { color:red; font-weight:bold; }
  .o-mark { color:blue; font-weight:bold; }
  .big-winner { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; font-size:3em; pointer-events:none; }
  #top-bar { margin-top:10px; }
  #onlineControls input { padding:5px; border-radius:5px; border:1px solid #999; }
  #onlineControls button { padding:5px 10px; border-radius:5px; border:none; background:#2563eb; color:white; cursor:pointer; }
</style>

<!-- Firebase scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>Super Tres-en-raya</h1>
<div id="top-bar">
  <span id="turnIndicator">Turno: X</span>
  <button id="resetBtn">Reiniciar</button>
</div>

<div id="onlineControls" style="margin-top:10px;">
  <input id="roomInput" placeholder="Código sala">
  <button id="createRoomBtn">Crear sala</button>
  <button id="joinRoomBtn">Unirse</button>
  <span id="roomStatus"></span>
</div>

<div id="game"></div>

<script>
/* ---------------- Variables globales ---------------- */
let currentPlayer='X';
let nextRequired=null;
let bigBoardWinners=Array(9).fill(null);
let boards=[];
let gameOver=false;
  
const firebaseConfig = {
  apiKey: "AIzaSyDdGTY54_gKiCHutZUdo0dfN0HXbEE4Tok",
  authDomain: "super-tres-en-raya.firebaseapp.com",
  projectId: "super-tres-en-raya",
  storageBucket: "super-tres-en-raya.firebasestorage.app",
  messagingSenderId: "1095062617604",
  appId: "1:1095062617604:web:b8c3577d78b1a660e03f51"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------- Variables online ---------------- */
let roomId = null;
let isHost = false;
let playerSymbol = null;
let applyingRemote = false;

const roomInput = document.getElementById('roomInput');
const createRoomBtn = document.getElementById('createRoomBtn');
const joinRoomBtn = document.getElementById('joinRoomBtn');
const roomStatus = document.getElementById('roomStatus');
const turnIndicator = document.getElementById('turnIndicator');
const resetBtn = document.getElementById('resetBtn');

/* ------------------- Crear tablero ------------------- */
function createBoardUI(){
  const gameDiv = document.getElementById('game');
  gameDiv.innerHTML='';
  for(let b=0;b<9;b++){
    const board = document.createElement('div');
    board.className='board';
    board.id='board-'+b;
    board.dataset.index=b;
    board.cells=[];
    for(let c=0;c<9;c++){
      const cell=document.createElement('div');
      cell.className='cell';
      cell.dataset.index=c;
      cell.id=b${b}c${c};
      cell.addEventListener('click', ()=>handleMove(board,cell));
      board.appendChild(cell);
      board.cells.push(cell);
    }
    gameDiv.appendChild(board);
    boards.push(board);
  }
}

/* ------------------- Manejo de jugadas ------------------- */
function handleMove(boardEl, cellEl){
  if(gameOver || applyingRemote) return;
  const bigIndex = Number(boardEl.dataset.index);
  const cellIndex = Number(cellEl.dataset.index);
  if(nextRequired!==null && nextRequired!==bigIndex) return;
  if(cellEl.textContent) return;
  if(bigBoardWinners[bigIndex]) return;

  if(roomId){
    if(!playerSymbol) return;
    if(currentPlayer!==playerSymbol) return;
  }

  cellEl.innerHTML = currentPlayer==='X'? '<span class="x-mark">X</span>':'<span class="o-mark">O</span>';
  checkSmallWin(bigIndex);

  nextRequired = cellIndex;
  if(nextRequired!==null && bigBoardWinners[nextRequired]) nextRequired=null;

  currentPlayer = currentPlayer==='X'?'O':'X';
  turnIndicator.textContent='Turno: '+currentPlayer;
  updateHighlights();
  checkGlobalWinner();

  if(roomId) pushStateToFirebase();
}

/* ------------------- Resaltar tablero permitido ------------------- */
function updateHighlights(){
  boards.forEach((b,i)=>{
    b.cells.forEach(c=>{
      c.classList.remove('allowed');
    });
    if(gameOver) return;
    if(nextRequired===null){
      b.cells.forEach(c=>c.classList.add('allowed'));
    } else if(!bigBoardWinners[nextRequired]){
      b.cells.forEach(c=>c.classList.add('allowed'));
    }
  });
}

/* ------------------- Revisar ganadores ------------------- */
function checkSmallWin(bi){
  const cells=boards[bi].cells.map(c=>c.textContent);
  const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for(const w of wins){
    if(cells[w[0]] && cells[w[0]]===cells[w[1]] && cells[w[1]]===cells[w[2]]){
      bigBoardWinners[bi]=cells[w[0]];
      const overlay=document.createElement('div');
      overlay.className='big-winner';
      overlay.innerHTML=cells[w[0]]==='X'?'<span class="x-mark">X</span>':'<span class="o-mark">O</span>';
      boards[bi].appendChild(overlay);
      boards[bi].cells.forEach(c=>c.classList.add('disabled'));
      break;
    }
  }
}

function checkGlobalWinner(){
  const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for(const w of wins){
    if(bigBoardWinners[w[0]] && bigBoardWinners[w[0]]===bigBoardWinners[w[1]] && bigBoardWinners[w[1]]===bigBoardWinners[w[2]]){
      gameOver=true;
      alert('¡Jugador '+bigBoardWinners[w[0]]+' ganó el tablero grande!');
      break;
    }
  }
}

/* ------------------- Reset ------------------- */
resetBtn.addEventListener('click', ()=>{
  boards=[];
  currentPlayer='X';
  nextRequired=null;
  bigBoardWinners=Array(9).fill(null);
  gameOver=false;
  createBoardUI();
  updateHighlights();
});

/* ------------------- Firebase online ------------------- */
function generateRoomId(){ return Math.random().toString(36).slice(2,8); }

createRoomBtn.addEventListener('click', ()=>{
  const id = roomInput.value.trim()||generateRoomId();
  roomId=id;
  isHost=true;
  playerSymbol='X';
  pushStateToFirebase();
  db.ref('rooms/'+roomId+'/state').on('value', onRemoteStateChange);
  roomStatus.textContent=Sala ${roomId} (Host - X);
});

joinRoomBtn.addEventListener('click', ()=>{
  const id=roomInput.value.trim();
  if(!id){ alert('Pon un código de sala'); return; }
  roomId=id;
  playerSymbol='O';
  isHost=false;
  db.ref('rooms/'+roomId+'/state').on('value', onRemoteStateChange);
  db.ref('rooms/'+roomId+'/state').once('value').then(snap=>{if(snap.exists()) applyRemoteState(snap.val());});
  roomStatus.textContent=Conectado sala ${roomId} (O);
});

function pushStateToFirebase(){
  if(!roomId) return;
  const state={
    boards: boards.map(b=>b.cells.map(c=>c.textContent||'')),
    bigBoardWinners: bigBoardWinners.slice(),
    currentPlayer,
    nextRequired,
    gameOver
  };
  db.ref('rooms/'+roomId+'/state').set(state);
}

function onRemoteStateChange(snapshot){
  const val=snapshot.val();
  if(!val) return;
  applyingRemote=true;
  applyRemoteState(val);
  applyingRemote=false;
}

function applyRemoteState(state){
  state.boards.forEach((boardArr,bi)=>{
    boardArr.forEach((cellVal,ci)=>{
      const el=document.getElementById(b${bi}c${ci});
      if(el){
        el.innerHTML=cellVal? <span class="${cellVal==='X'?'x-mark':'o-mark'}">${cellVal}</span>:'';
        el.classList.toggle('disabled',!!cellVal);
      }
    });
  });
  for(let i=0;i<9;i++){
    bigBoardWinners[i]=state.bigBoardWinners[i];
    const boardEl=document.getElementById('board-'+i);
    if(!boardEl) continue;
    const existing=boardEl.querySelector('.big-winner');
    if(existing) existing.remove();
    if(bigBoardWinners[i]){
      const overlay=document.createElement('div');
      overlay.className='big-winner';
      overlay.innerHTML=bigBoardWinners[i]==='X'?'<span class="x-mark">X</span>':'<span class="o-mark">O</span>';
      boardEl.appendChild(overlay);
      boardEl.cells.forEach(c=>{ c.classList.add('disabled'); });
    }
  }
  currentPlayer=state.currentPlayer;
  nextRequired=state.nextRequired;
  gameOver=state.gameOver;
  turnIndicator.textContent='Turno: '+currentPlayer;
  updateHighlights();
}

/* ------------------- Inicialización ------------------- */
createBoardUI();
updateHighlights();
</script>
</body>
</html>
