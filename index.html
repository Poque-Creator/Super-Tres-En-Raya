<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Super Tres-en-raya</title>
<style>
:root{--bg1:#0f172a;--bg2:#1e293b;--card:#1e293b;--accent:#3b82f6;--accent-weak:rgba(59,130,246,0.15);--x:#ef4444;--o:#3b82f6;--text:#f1f5f9}
body{margin:0;font-family:'Segoe UI', system-ui, sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));display:flex;flex-direction:column;align-items:center;min-height:100vh;color:var(--text);padding:18px}
#top-bar{margin-bottom:16px;display:flex;gap:18px;font-size:18px;align-items:center}
#resetBtn{padding:10px 20px;font-size:14px;border:none;border-radius:8px;background:var(--accent);color:white;cursor:pointer;box-shadow:0 4px 12px rgba(59,130,246,0.3);transition:all 200ms ease;font-weight:600}
#resetBtn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,0.4)}
#rankingYemazo{padding:10px 20px;font-size:14px;border:none;border-radius:8px;background:var(--accent);color:white;cursor:pointer;box-shadow:0 4px 12px rgba(59,130,246,0.3);transition:all 200ms ease;font-weight:600}
#rankingYemazo:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,0.4)}
#turnIndicator{font-weight:700}
#game{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:min(88vmin,920px);height:min(88vmin,920px)}
.big-board{background:var(--card);border:3px solid #334155;border-radius:12px;display:grid;grid-template-columns:repeat(3,1fr);aspect-ratio:1/1;position:relative;overflow:hidden;transition:border-color 220ms ease,box-shadow 220ms ease,transform 200ms ease;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.big-board.super-highlight{border-color:var(--accent);box-shadow:0 0 30px var(--accent-weak),0 4px 12px rgba(0,0,0,0.3);transform:scale(1.02)}
@keyframes pulse-ring{0%{box-shadow:0 0 0 0 rgba(59,130,246,0.4)}50%{box-shadow:0 0 20px 6px rgba(59,130,246,0.0)}100%{box-shadow:0 0 0 0 rgba(59,130,246,0.0)}}
.big-board.super-highlight::after{content:'';position:absolute;inset:0;border-radius:10px;pointer-events:none;animation:pulse-ring 1200ms infinite}
.cell{border:1px solid #475569;display:flex;justify-content:center;align-items:center;font-size:clamp(18px,3.6vmin,34px);cursor:pointer;background:#2d3748;transition:transform 140ms ease,background 140ms ease;min-height:0;line-height:1}
.cell:hover{transform:scale(1.05);background:#374151}
.cell.disabled{cursor:default;opacity:0.7}
.cell.allowed{background:#1e3a5f;box-shadow:inset 0 0 20px rgba(59,130,246,0.2)}
.x-mark{color:var(--x);font-weight:800;display:inline-block;width:1em;height:1em;line-height:1}
.o-mark{color:var(--o);font-weight:800;display:inline-block;width:1em;height:1em;line-height:1}
.big-winner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:clamp(44px,12vmin,140px);font-weight:900;background:rgba(30,41,59,0.95);backdrop-filter:blur(4px)}
#gameResultBanner{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;padding:14px 28px;border-radius:12px;box-shadow:0 8px 30px rgba(59,130,246,0.4);display:none;font-weight:700;z-index:60;border:2px solid rgba(255,255,255,0.2)}
#botControls{margin-bottom:16px;display:flex;gap:10px;align-items:center;font-size:16px;background:rgba(30,41,59,0.6);padding:12px 20px;border-radius:10px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1)}
#modeSelect{padding:8px 12px;border-radius:6px;border:1px solid #475569;background:#1e293b;color:var(--text);font-size:14px;cursor:pointer;font-weight:500}
#modeSelect:focus{outline:2px solid var(--accent);outline-offset:2px}
</style>
</head>
<body>
<div id="gameResultBanner"></div>
<div id="top-bar">
  <div id="turnIndicator">Turno: X</div>
  <button id="resetBtn">Reiniciar</button>
  <button id="rankingYemazo" onclick="window.location.href='https://poque-creator.github.io/Ranking-Elo/';">Ranking Elo</button>
</div>
<div id="botControls">
  <label>Modo Bot: </label>
  <select id="modeSelect">
    <option value="pvp">Jugador vs Jugador</option>
    <option value="bot_easy">Bot Fácil</option>
    <option value="bot_hard">Bot Difícil</option>
  </select>
</div>
<div id="game"></div>
<script>
const gameEl=document.getElementById('game');
const resetBtn=document.getElementById('resetBtn');
const turnIndicator=document.getElementById('turnIndicator');
const banner=document.getElementById('gameResultBanner');
const modeSelect=document.getElementById('modeSelect');
let currentPlayer='X';
let nextRequired=null;
let bigBoardWinners=Array(9).fill(null);
let boards=[];
let gameOver=false;
let botMode='pvp';
const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
modeSelect.addEventListener('change',()=>{botMode=modeSelect.value});

function createBoard(index){
  const board=document.createElement('div');
  board.className='big-board';
  board.dataset.index=index;
  const cells=[];
  for(let i=0;i<9;i++){
    const cell=document.createElement('div');
    cell.className='cell';
    cell.dataset.index=i;
    cell.addEventListener('click',()=>handleMove(board,cell));
    board.appendChild(cell);
    cells.push(cell);
  }
  return {board,cells};
}

function init(){
  gameEl.innerHTML='';
  boards=[];
  bigBoardWinners=Array(9).fill(null);
  currentPlayer='X';
  nextRequired=null;
  gameOver=false;
  turnIndicator.textContent='Turno: '+currentPlayer;
  banner.style.display='none';
  for(let i=0;i<9;i++){
    const b=createBoard(i);
    boards.push(b);
    gameEl.appendChild(b.board);
  }
  updateHighlights();
  if(botMode.startsWith('bot') && currentPlayer==='O'){botMove()}
}

function updateHighlights(){
  boards.forEach((b,i)=>{
    b.board.classList.remove('super-highlight');
    b.cells.forEach(c=>c.classList.remove('allowed'));
    if(bigBoardWinners[i]){
      b.board.querySelectorAll('.cell').forEach(c=>c.classList.add('disabled'));
      return;
    }
    if(nextRequired===null||nextRequired===i){
      b.board.classList.add('super-highlight');
      b.cells.forEach(c=>{if(!c.textContent)c.classList.add('allowed')});
    }
  });
}

function handleMove(boardEl,cellEl){
  if(gameOver)return;
  const bigIndex=Number(boardEl.dataset.index);
  const cellIndex=Number(cellEl.dataset.index);
  if(nextRequired!==null&&nextRequired!==bigIndex)return;
  if(cellEl.textContent)return;
  if(bigBoardWinners[bigIndex])return;
  cellEl.innerHTML=currentPlayer==='X'?'<span class="x-mark">X</span>':'<span class="o-mark">O</span>';
  checkSmallWin(bigIndex);
  nextRequired=cellIndex;
  if(nextRequired!==null&&bigBoardWinners[nextRequired])nextRequired=null;
  currentPlayer=currentPlayer==='X'?'O':'X';
  turnIndicator.textContent='Turno: '+currentPlayer;
  updateHighlights();
  checkGlobalWinner();
  if(!gameOver && botMode.startsWith('bot') && currentPlayer==='O'){
    setTimeout(botMove,300);
  }
}

function checkSmallWin(bigIndex){
  const {cells,board}=boards[bigIndex];
  const vals=cells.map(c=>c.textContent.trim()||'');
  for(const line of wins){
    const [a,b,c]=line;
    if(vals[a]&&vals[a]===vals[b]&&vals[a]===vals[c]){
      bigBoardWinners[bigIndex]=vals[a];
      placeBigWinner(board,vals[a]);
      return;
    }
  }
  if(vals.every(v=>v)){
    bigBoardWinners[bigIndex]='T';
    placeBigWinner(board,null);
  }
}

function placeBigWinner(boardEl,winner){
  const overlay=document.createElement('div');
  overlay.className='big-winner';
  if(winner==='X')overlay.innerHTML='<span class="x-mark">X</span>';
  else if(winner==='O')overlay.innerHTML='<span class="o-mark">O</span>';
  else overlay.innerHTML='<span style="color:#64748b;font-weight:800">●</span>';
  boardEl.appendChild(overlay);
  boardEl.querySelectorAll('.cell').forEach(c=>{c.style.pointerEvents='none';c.classList.add('disabled');c.classList.remove('allowed')});
}

function checkGlobalWinner(){
  const g=bigBoardWinners.map(x=>(x==='X'||x==='O')?x:'');
  for(const line of wins){
    const [a,b,c]=line;
    if(g[a]&&g[a]===g[b]&&g[a]===g[c]){
      gameOver=true;
      boards.forEach(b=>b.board.querySelectorAll('.cell').forEach(c=>c.style.pointerEvents='none'));
      showGameResult('¡Ha ganado el jugador '+g[a]+' en el tablero grande!');
      return;
    }
  }
  if(bigBoardWinners.every(x=>x)){
    gameOver=true;
    showGameResult('Empate global');
  }
}

function showGameResult(text){
  banner.textContent=text;
  banner.style.display='block';
  banner.animate([{transform:'translateY(-10px)',opacity:0},{transform:'translateY(0)',opacity:1}],{duration:360,easing:'cubic-bezier(.2,.9,.2,1)'});
}

function botMove(){
  if(gameOver)return;
  let options=[];
  if(nextRequired!==null){
    options=boards[nextRequired].cells.filter(c=>!c.textContent);
  }else{
    boards.forEach(b=>{
      if(!bigBoardWinners[b.board.dataset.index])b.cells.forEach(c=>{if(!c.textContent)options.push(c)})
    });
  }
  if(options.length===0)return;
  let choice;
  if(botMode==='bot_easy'){
    choice=mediumBotChoice(options);
  } else {
    choice=difficultBotChoice(options);
  }
  const boardEl=choice.parentElement;
  handleMove(boardEl,choice);
}

function mediumBotChoice(options){
  for(const c of options){
    const bIndex=c.parentElement.dataset.index;
    const cells=boards[bIndex].cells.map(cl=>cl.textContent.trim()||'');
    cells[c.dataset.index]=currentPlayer;
    for(const line of wins){
      const [a,b,d]=line;
      if(cells[a]&&cells[a]===cells[b]&&cells[a]===cells[d]) return c;
    }
  }
  return options[Math.floor(Math.random()*options.length)];
}

function difficultBotChoice(options){
  let bestMove=null;
  let bestScore=-Infinity;
  
  for(const c of options){
    const bIndex=Number(c.parentElement.dataset.index);
    const cellIndex=Number(c.dataset.index);
    const score=evaluateMove(bIndex,cellIndex);
    if(score>bestScore){
      bestScore=score;
      bestMove=c;
    }
  }
  return bestMove||options[0];
}

function evaluateMove(boardIndex,cellIndex){
  let score=0;
  
  if(canWinSmallBoard(boardIndex,cellIndex,'O')) score+=10000;
  if(canWinSmallBoard(boardIndex,cellIndex,'X')) score+=8000;
  if(leadsToGlobalWin(boardIndex,cellIndex,'O')) score+=50000;
  if(leadsToGlobalWin(boardIndex,cellIndex,'X')) score+=40000;
  
  if(boardIndex===4) score+=500;
  if([0,2,6,8].includes(boardIndex)) score+=300;
  if(cellIndex===4) score+=200;
  if([0,2,6,8].includes(cellIndex)) score+=100;
  
  score+=countThreats(boardIndex,cellIndex,'O')*400;
  
  if(nextRequired===null||nextRequired===boardIndex){
    const nextBoard=cellIndex;
    if(bigBoardWinners[nextBoard]===null){
      if(isOpponentStrongInBoard(nextBoard)) score-=600;
      if(canOpponentWinBoard(nextBoard)) score-=1000;
    }
  }
  
  score+=evaluateBoardControl(boardIndex,'O')*150;
  if(isOpponentStrongInBoard(boardIndex)) score-=200;
  
  return score;
}

function canWinSmallBoard(boardIndex,cellIndex,player){
  const cells=boards[boardIndex].cells.map(c=>c.textContent.trim()||'');
  cells[cellIndex]=player;
  for(const line of wins){
    const [a,b,c]=line;
    if(cells[a]===player&&cells[b]===player&&cells[c]===player)return true;
  }
  return false;
}

function leadsToGlobalWin(boardIndex,cellIndex,player){
  if(!canWinSmallBoard(boardIndex,cellIndex,player))return false;
  const tempBig=[...bigBoardWinners];
  tempBig[boardIndex]=player;
  for(const line of wins){
    const [a,b,c]=line;
    if(tempBig[a]===player&&tempBig[b]===player&&tempBig[c]===player)return true;
  }
  return false;
}

function countThreats(boardIndex,cellIndex,player){
  const cells=boards[boardIndex].cells.map(c=>c.textContent.trim()||'');
  cells[cellIndex]=player;
  let threats=0;
  for(const line of wins){
    const [a,b,c]=line;
    const vals=[cells[a],cells[b],cells[c]];
    const playerCount=vals.filter(v=>v===player).length;
    const emptyCount=vals.filter(v=>!v).length;
    if(playerCount===2&&emptyCount===1)threats++;
  }
  return threats;
}

function isOpponentStrongInBoard(boardIndex){
  if(bigBoardWinners[boardIndex])return false;
  const cells=boards[boardIndex].cells.map(c=>c.textContent.trim()||'');
  let xCount=cells.filter(c=>c==='X').length;
  let oCount=cells.filter(c=>c==='O').length;
  return xCount>oCount+1;
}

function canOpponentWinBoard(boardIndex){
  if(bigBoardWinners[boardIndex])return false;
  const cells=boards[boardIndex].cells.map(c=>c.textContent.trim()||'');
  for(const line of wins){
    const [a,b,c]=line;
    const vals=[cells[a],cells[b],cells[c]];
    const xCount=vals.filter(v=>v==='X').length;
    const emptyCount=vals.filter(v=>!v).length;
    if(xCount===2&&emptyCount===1)return true;
  }
  return false;
}

function evaluateBoardControl(boardIndex,player){
  if(bigBoardWinners[boardIndex])return 0;
  const cells=boards[boardIndex].cells.map(c=>c.textContent.trim()||'');
  let control=0;
  for(const line of wins){
    const [a,b,c]=line;
    const vals=[cells[a],cells[b],cells[c]];
    const playerCount=vals.filter(v=>v===player).length;
    const oppCount=vals.filter(v=>v&&v!==player).length;
    if(oppCount===0&&playerCount>0)control+=playerCount;
  }
  return control;
}

resetBtn.addEventListener('click',init);
init();
</script>
</body>
</html>
